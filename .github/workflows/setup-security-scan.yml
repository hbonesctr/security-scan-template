name: Setup Security Scanning

on:
  workflow_dispatch:
    inputs:
      enable_snyk:
        description: 'Enable Snyk scanning (requires SNYK_TOKEN secret)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  issues: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5  # Updated to v5
      
      - name: Create workflows directory
        run: mkdir -p .github/workflows
      
      - name: Create CodeQL workflow
        run: |
          cat > .github/workflows/codeql-analysis.yml << 'EOF'
          name: CodeQL Analysis
          
          on:
            push:
              branches: [ main, master ]
            pull_request:
              branches: [ main, master ]
            schedule:
              - cron: '0 6 * * 1'  # Weekly Monday 6 AM UTC
            workflow_dispatch:  # Manual trigger
          
          permissions:
            actions: read
            contents: read
            security-events: write
          
          jobs:
            analyze:
              name: Analyze (${{ matrix.language }})
              runs-on: ubuntu-latest
              timeout-minutes: 360
              
              permissions:
                security-events: write
                packages: read
                actions: read
                contents: read
              
              strategy:
                fail-fast: false
                matrix:
                  include:
                    - language: javascript-typescript
                      build-mode: none
                    - language: python
                      build-mode: none
              
              steps:
              - name: Checkout repository
                uses: actions/checkout@v5  # Updated to v5
              
              - name: Initialize CodeQL
                uses: github/codeql-action/init@v4  # Updated to v4
                with:
                  languages: ${{ matrix.language }}
                  build-mode: ${{ matrix.build-mode }}
                  queries: security-extended
              
              - name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@v4  # Updated to v4
                with:
                  category: "/language:${{ matrix.language }}"
          EOF
      
      - name: Create Snyk workflow
        if: inputs.enable_snyk
        run: |
          cat > .github/workflows/snyk-security.yml << 'EOF'
          name: Snyk Security
          
          on:
            push:
              branches: [ main, master ]
            pull_request:
              branches: [ main, master ]
            schedule:
              - cron: '0 7 * * 1'  # Weekly Monday 7 AM UTC
            workflow_dispatch:
          
          permissions:
            contents: read
            security-events: write
          
          jobs:
            snyk:
              runs-on: ubuntu-latest
              steps:
                - name: Checkout code
                  uses: actions/checkout@v5  # Updated to v5
                
                - name: Setup Node.js
                  uses: actions/setup-node@v4  # Updated to v4
                  with:
                    node-version: '20'  # Updated to Node 20 LTS
                
                - name: Install dependencies
                  run: |
                    if [ -f package.json ]; then npm ci 2>/dev/null || npm install; fi
                    if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
                  continue-on-error: true
                
                - name: Run Snyk Security Scan
                  uses: snyk/actions/node@master
                  continue-on-error: true
                  env:
                    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
                  with:
                    args: --all-projects --severity-threshold=low
                
                - name: Upload Snyk results to GitHub Code Scanning
                  uses: github/codeql-action/upload-sarif@v4  # Updated to v4
                  if: always()
                  with:
                    sarif_file: snyk.sarif
          EOF
      
      - name: Create Dependabot config
        run: |
          mkdir -p .github
          cat > .github/dependabot.yml << 'EOF'
          version: 2
          updates:
            - package-ecosystem: "github-actions"
              directory: "/"
              schedule:
                interval: "weekly"
            - package-ecosystem: "npm"
              directory: "/"
              schedule:
                interval: "weekly"
              open-pull-requests-limit: 10
          EOF
      
      - name: Commit workflows
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/
          git diff --staged --quiet || git commit -m "ðŸ” Add security scanning workflows and Dependabot config"
          git push
      
      - name: Create setup instructions issue
        uses: actions/github-script@v7
        with:
          script: |
            const snykEnabled = '${{ inputs.enable_snyk }}' === 'true';
            
            const body = `## ðŸŽ‰ Security Scanning Setup Complete!
            
            ### âœ… Installed Workflows:
            - **CodeQL Analysis v4** (Latest) - SAST scanning
            ${snykEnabled ? '- **Snyk Security** - Dependency and code scanning' : '- â­ï¸ Snyk (skipped)'}
            - **Dependabot** - Automated dependency updates
            
            ### ðŸ“‹ Next Steps:
            
            ${snykEnabled ? `#### 1. Add Snyk Token
            
            Get your token from [app.snyk.io/account](https://app.snyk.io/account)
            
            Then add it:
            - Go to [Settings â†’ Secrets â†’ Actions](/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)
            - Click **"New repository secret"**
            - Name: \`SNYK_TOKEN\`
            - Value: (paste token)
            - Click **"Add secret"**
            ` : ''}
            
            #### ${snykEnabled ? '2' : '1'}. Enable GitHub Security Features
            
            Go to [Settings â†’ Code security](/${context.repo.owner}/${context.repo.repo}/settings/security_analysis):
            - âœ… Enable **Dependabot alerts**
            - âœ… Enable **Dependabot security updates** 
            - âœ… Enable **Secret scanning** (if available)
            - âœ… Enable **Push protection for secrets**
            
            #### ${snykEnabled ? '3' : '2'}. Verify Workflows
            
            - Go to [Actions tab](/${context.repo.owner}/${context.repo.repo}/actions)
            - Workflows run automatically on next push
            - Or click **"Run workflow"** to trigger now
            
            ### ðŸ“Š View Results
            
            - **Code Scanning:** [Security â†’ Code scanning](/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            - **Dependabot:** [Security â†’ Dependabot](/${context.repo.owner}/${context.repo.repo}/security/dependabot)
            ${snykEnabled ? '- **Snyk Dashboard:** [app.snyk.io](https://app.snyk.io/)' : ''}
            
            ### ðŸ”„ What Changed (Nov 2025 Updates):
            - Using CodeQL v4 (latest, v3 deprecated Dec 2026)
            - Using actions/checkout@v5
            - Using actions/setup-node@v4  
            - Node.js 20 LTS (current long-term support)
            - Added Dependabot auto-updates
            - Enhanced permissions for security
            
            ---
            
            âœ… **Close this issue once setup is complete.**`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ” Security Scanning Setup Complete - Next Steps',
              body: body,
              labels: ['security', 'setup', 'documentation']
            });
