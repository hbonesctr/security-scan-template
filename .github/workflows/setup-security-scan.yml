# DoD Security Scanning Setup Workflow
# Purpose: Automated installation of security scanning tools
# Compliance: DISA STIG, DoDI 8500.01, NIST SP 800-53
# Version: 1.0
# Date: 2025-11-19

name: Setup Security Scanning

on:
  workflow_dispatch:
    inputs:
      enable_snyk:
        description: 'Enable Snyk scanning (requires SNYK_TOKEN secret)'
        required: false
        type: boolean
        default: true
      enable_dependabot:
        description: 'Enable Dependabot configuration'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  issues: write
  security-events: write

jobs:
  setup:
    name: Install Security Scanning Tools
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create workflows directory
        run: mkdir -p .github/workflows
      
      - name: Install CodeQL Analysis Workflow
        run: |
          cat > .github/workflows/codeql-analysis.yml << 'CODEQL_EOF'
          # CodeQL Analysis Workflow
          # STIG ID: APSC-DV-002560 - Static Analysis Execution
          # Version: 1.0
          
          name: CodeQL Security Analysis
          
          on:
            push:
              branches: [ main, master, develop ]
            pull_request:
              branches: [ main, master, develop ]
            schedule:
              # Weekly scan: Monday at 0600 UTC
              - cron: '0 6 * * 1'
            workflow_dispatch:
          
          permissions:
            actions: read
            contents: read
            security-events: write
          
          jobs:
            analyze:
              name: CodeQL Analysis (${{ matrix.language }})
              runs-on: ubuntu-latest
              timeout-minutes: 360
              
              permissions:
                security-events: write
                packages: read
                actions: read
                contents: read
              
              strategy:
                fail-fast: false
                matrix:
                  include:
                    - language: javascript-typescript
                      build-mode: none
                    - language: python
                      build-mode: none
                    - language: java
                      build-mode: none
                    - language: go
                      build-mode: none
              
              steps:
              - name: Checkout repository
                uses: actions/checkout@v5
              
              - name: Initialize CodeQL
                uses: github/codeql-action/init@v4
                with:
                  languages: ${{ matrix.language }}
                  build-mode: ${{ matrix.build-mode }}
                  queries: security-extended
              
              - name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@v4
                with:
                  category: "/language:${{ matrix.language }}"
                  upload: true
          CODEQL_EOF
      
      - name: Install Snyk Security Workflow
        if: inputs.enable_snyk == true
        run: |
          cat > .github/workflows/snyk-security.yml << 'SNYK_EOF'
          # Snyk Security Analysis Workflow
          # STIG ID: APSC-DV-003235 - Dependency Vulnerability Scanning
          # Version: 1.0
          
          name: Snyk Security Analysis
          
          on:
            push:
              branches: [ main, master, develop ]
            pull_request:
              branches: [ main, master, develop ]
            schedule:
              # Weekly scan: Monday at 0700 UTC
              - cron: '0 7 * * 1'
            workflow_dispatch:
          
          permissions:
            contents: read
            security-events: write
          
          jobs:
            snyk-scan:
              name: Snyk Security Scan
              runs-on: ubuntu-latest
              
              steps:
                - name: Checkout repository
                  uses: actions/checkout@v5
                
                - name: Setup Node.js
                  uses: actions/setup-node@v4
                  with:
                    node-version: '20'
                
                - name: Setup Python
                  uses: actions/setup-python@v5
                  with:
                    python-version: '3.11'
                
                - name: Install dependencies
                  run: |
                    # Node.js dependencies
                    if [ -f package.json ]; then
                      npm ci 2>/dev/null || npm install || echo "No Node.js dependencies"
                    fi
                    
                    # Python dependencies
                    if [ -f requirements.txt ]; then
                      pip install -r requirements.txt || echo "No Python dependencies"
                    fi
                  continue-on-error: true
                
                - name: Run Snyk Open Source Scan
                  uses: snyk/actions/node@master
                  continue-on-error: true
                  env:
                    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
                  with:
                    args: --all-projects --severity-threshold=low --sarif-file-output=snyk-opensource.sarif
                
                - name: Run Snyk Code Analysis
                  uses: snyk/actions/node@master
                  continue-on-error: true
                  env:
                    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
                  with:
                    command: code test
                    args: --sarif-file-output=snyk-code.sarif
                
                - name: Upload Snyk results to GitHub Code Scanning
                  uses: github/codeql-action/upload-sarif@v4
                  if: always()
                  with:
                    sarif_file: snyk-opensource.sarif
                    category: snyk-opensource
                  continue-on-error: true
                
                - name: Upload Snyk Code results
                  uses: github/codeql-action/upload-sarif@v4
                  if: always()
                  with:
                    sarif_file: snyk-code.sarif
                    category: snyk-code
                  continue-on-error: true
          SNYK_EOF
      
      - name: Install Dependabot Configuration
        if: inputs.enable_dependabot == true
        run: |
          cat > .github/dependabot.yml << 'DEPENDABOT_EOF'
          # Dependabot Configuration
          # STIG ID: APSC-DV-003235 - Dependency Management
          # Version: 1.0
          
          version: 2
          updates:
            # GitHub Actions dependency updates
            - package-ecosystem: "github-actions"
              directory: "/"
              schedule:
                interval: "weekly"
                day: "monday"
                time: "06:00"
              open-pull-requests-limit: 10
              labels:
                - "dependencies"
                - "github-actions"
            
            # npm dependency updates
            - package-ecosystem: "npm"
              directory: "/"
              schedule:
                interval: "weekly"
                day: "monday"
                time: "06:00"
              open-pull-requests-limit: 10
              labels:
                - "dependencies"
                - "npm"
            
            # pip dependency updates
            - package-ecosystem: "pip"
              directory: "/"
              schedule:
                interval: "weekly"
                day: "monday"
                time: "06:00"
              open-pull-requests-limit: 10
              labels:
                - "dependencies"
                - "python"
          DEPENDABOT_EOF
      
      - name: Commit security workflows
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ” Install DoD-compliant security scanning workflows

          Installed workflows:
          - CodeQL Analysis (SAST)
          - Snyk Security (SCA)
          - Dependabot (Dependency Management)
          
          Compliance:
          - DISA STIG APSC-DV-002560
          - DISA STIG APSC-DV-003235
          - NIST SP 800-53 RA-5
          - NIST SP 800-53 SI-2"
            git push
          fi
      
      - name: Create setup completion issue
        uses: actions/github-script@v7
        with:
          script: |
            const snykEnabled = ${{ inputs.enable_snyk }};
            const dependabotEnabled = ${{ inputs.enable_dependabot }};
            
            const body = `## ðŸ” Security Scanning Setup Complete
            
            **Status:** âœ… Installation Successful  
            **Date:** ${new Date().toISOString().split('T')[0]}  
            **Compliance:** DoD Cybersecurity Requirements
            
            ---
            
            ### âœ… Installed Components
            
            | Component | Status | STIG Reference |
            |-----------|--------|----------------|
            | CodeQL Analysis (SAST) | âœ… Installed | APSC-DV-002560 |
            ${snykEnabled ? '| Snyk Security (SCA) | âœ… Installed | APSC-DV-003235 |' : '| Snyk Security (SCA) | â­ï¸ Skipped | - |'}
            ${dependabotEnabled ? '| Dependabot Config | âœ… Installed | APSC-DV-003235 |' : '| Dependabot Config | â­ï¸ Skipped | - |'}
            
            ---
            
            ### ðŸ“‹ Required Actions
            
            ${snykEnabled ? `#### 1. Configure Snyk Token
            
            **Required for Snyk scanning to function**
            
            a. **Obtain Snyk API Token:**
               - Visit: [app.snyk.io/account](https://app.snyk.io/account)
               - Copy your API token
            
            b. **Add to GitHub Secrets:**
               - Navigate to: [Settings â†’ Secrets â†’ Actions](/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)
               - Click **"New repository secret"**
               - **Name:** \`SNYK_TOKEN\`
               - **Value:** (paste your Snyk API token)
               - Click **"Add secret"**
            
            ---
            ` : ''}
            
            #### ${snykEnabled ? '2' : '1'}. Enable GitHub Security Features
            
            **Navigate to:** [Settings â†’ Code security](/${context.repo.owner}/${context.repo.repo}/settings/security_analysis)
            
            **Enable the following:**
            - âœ… **Dependabot alerts**
            - âœ… **Dependabot security updates**
            - âœ… **Secret scanning** (if available)
            - âœ… **Push protection for secrets**
            
            ---
            
            #### ${snykEnabled ? '3' : '2'}. Verify Workflow Execution
            
            **Option A: Trigger Manual Scan**
            1. Go to [Actions tab](/${context.repo.owner}/${context.repo.repo}/actions)
            2. Select "CodeQL Security Analysis"
            3. Click "Run workflow" dropdown
            4. Click "Run workflow" button
            
            **Option B: Automatic Trigger**
            - Workflows run automatically on next push to main branch
            - Scheduled scans: Every Monday at 06:00 UTC
            
            ---
            
            ### ðŸ“Š Viewing Results
            
            **Code Scanning Alerts:**
            - Location: [Security â†’ Code scanning](/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            - Content: SAST findings from CodeQL${snykEnabled ? ' and Snyk Code' : ''}
            
            **Dependency Alerts:**
            - Location: [Security â†’ Dependabot](/${context.repo.owner}/${context.repo.repo}/security/dependabot)
            - Content: Vulnerable dependencies
            
            ${snykEnabled ? `**Snyk Dashboard:**
            - Location: [app.snyk.io](https://app.snyk.io/)
            - Content: Centralized vulnerability management
            ` : ''}
            
            ---
            
            ### ðŸ“š DoD Compliance Mapping
            
            | Requirement | Control | Implementation |
            |-------------|---------|----------------|
            | DISA STIG APSC-DV-002560 | SAST Execution | CodeQL workflow |
            | DISA STIG APSC-DV-003235 | Dependency Scanning | Snyk + Dependabot |
            | NIST SP 800-53 RA-5 | Vulnerability Scanning | Automated weekly scans |
            | NIST SP 800-53 SI-2 | Flaw Remediation | Automated alerts + PRs |
            | NIST SP 800-218 | SSDF | Complete SDLC integration |
            
            ---
            
            ### ðŸ”„ Next Steps
            
            1. âœ… Complete required actions above
            2. âœ… Run test scan on sample vulnerable code
            3. âœ… Review and triage findings
            4. âœ… Document baseline security posture
            5. âœ… Establish weekly review process
            
            ---
            
            ### ðŸ“– References
            
            - [GitHub Code Scanning Docs](https://docs.github.com/en/code-security/code-scanning)
            - [CodeQL Documentation](https://codeql.github.com/docs/)
            - [Snyk Documentation](https://docs.snyk.io/)
            - [DISA STIGs](https://public.cyber.mil/stigs/)
            
            ---
            
            **Close this issue once all required actions are complete.**`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ” Security Scanning Setup Complete - Action Required',
              body: body,
              labels: ['security', 'setup', 'documentation', 'dod-compliance']
            });
